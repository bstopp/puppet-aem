#!/bin/bash
#
# This script is generated by the AEM Puppet module. 
# Do not manually edit this file.
#
# The original start script that came with the AEM installation 
# is named 'start-orig' in this folder.
#

if [ $FILE_SIZE_LIMIT ]; then
	CURRENT_ULIMIT=`ulimit`
	if [ $CURRENT_ULIMIT != "unlimited" ]; then
		if [ $CURRENT_ULIMIT -lt $FILE_SIZE_LIMIT ]; then
			echo "ulimit ${CURRENT_ULIMIT} is too small (must be at least ${FILE_SIZE_LIMIT})"
			exit 1
		fi
	fi
fi

BIN_PATH=$(dirname $0)
cd $BIN_PATH/..

. bin/start-env

if [ -z $JARFILE ]; then
	JARFILE=`ls app/*.jar | head -1`
fi

CURR_DIR=$(basename $(pwd))
cd ..

START_OPTS="start -c ${CURR_DIR} -i launchpad -p ${PORT}"
START_OPTS="${START_OPTS} -Dsling.properties=${SLING_PROPS}"

JVM_OPTS="${JVM_MEM_OPTS} ${JVM_OPTS} -Dsling.run.modes=${TYPE},${RUNMODES}"

#if [ $HOST ]; then
#	JVM_OPTS="${JVM_OPTS} -Dorg.apache.felix.http.host=${HOST}"
#    START_OPTS="${START_OPTS} -a ${HOST}"
#fi

#TODO Add if logic for erb based on feature mongo when implemented
#if [ $CQ_MONGO_HOST ]; then
#    START_OPTS="${START_OPTS} -Doak.mongo.host=${CQ_MONGO_HOST}"
#fi
#if [ $CQ_MONGO_PORT ]; then
#    START_OPTS="${START_OPTS} -Doak.mongo.port=${CQ_MONGO_PORT}"
#fi
#if [ $CQ_MONGO_DB ]; then
#    START_OPTS="${START_OPTS} -Doak.mongo.db=${CQ_MONGO_DB}"
#fi

#TODO Update this if version is < 5.6.1; or on crx2
#if [ $CQ_USE_JAAS ]; then
#    JVM_OPTS="${JVM_OPTS} -Djava.security.auth.login.config=${JAAS_CONFIG}"
#fi


(
  (
    java $JVM_OPTS -jar $CURR_DIR/$JARFILE $START_OPTS &
    echo $! > $CURR_DIR/conf/cq.pid
  ) >> $CURR_DIR/logs/stdout.log 2>&1
) &
